name: "Generate README"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'code_of_conduct/sections/**'
      - 'code_of_conduct/templates/**'
      - 'pyproject.toml'

jobs:
  generateREADME:
    name: "Generate README.md"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4"

      - name: "Install uv"
        uses: "astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a" # v4
        with:
          version: "latest"

      - name: "Set up Python"
        run: "uv python install"

      - name: "Generate the code of conduct"
        run: "uv run gencoc README.md"

      - name: "Amend PR with updated README"
        run: |
          # Check if this is a forked PR
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "You have not allowed edits from maintainers on this PR, please reopen the PR"
            echo "When creating the new PR, please allow edits from maintainers to autogenerate the README"
            exit 0
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md

          if ! git diff --staged --quiet; then
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
            git commit -m "chore(gencoc): update the code of conduct"
            git push origin "${HEAD_REF}"
            echo "README updated and pushed to PR branch"
          else
            echo "No changes to README.md"
          fi
