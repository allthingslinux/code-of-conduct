name: "Generate README"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'code_of_conduct/sections/**'
      - 'code_of_conduct/templates/**'
      - 'pyproject.toml'

jobs:
  generate-readme:
    name: "Generate README"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4"
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: "Setup branch"
        run: |
          git checkout -B ${{ github.event.pull_request.head.ref }}
          git branch --set-upstream-to=origin/${{ github.event.pull_request.head.ref }}

      - name: "Install uv"
        uses: "astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a" # v4
        with:
          version: "latest"

      - name: "Set up Python"
        run: "uv python install"

      - name: "Generate the code of conduct"
        run: "uv run gencoc README.md"

      - name: "Commit and push changes"
        if: github.event.pull_request.head.repo.full_name == github.repository || github.event.pull_request.maintainer_can_modify == true
        run: |
          # Check if this is a forked PR
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "You have not allowed edits from maintainers on this PR, please reopen the PR"
            echo "When creating the new PR, please allow edits from maintainers to autogenerate the README"
            exit 0
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md

          if ! git diff --staged --quiet; then
            git commit -m "chore(gencoc): update the code of conduct"
            git push origin ${{ github.event.pull_request.head.ref }}
            echo "README updated and pushed successfully"
          else
            echo "No changes to README.md"
          fi

      - name: "Fail for forked PRs without maintainer access"
        if: github.event.pull_request.head.repo.full_name != github.repository && github.event.pull_request.maintainer_can_modify != true
        run: |
          echo "::error::This is a forked PR without maintainer edit permissions"
          echo "::error::Enable 'Allow edits by maintainers' and recreate the PR to allow README auto-generation"
          exit 1
